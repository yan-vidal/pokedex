<div class="relative w-80 h-[520px] bg-red-600 rounded-l-2xl border-4 border-red-800 shadow-2xl flex flex-col p-6"
     (mousedown)="$event.stopPropagation()"
     (touchstart)="$event.stopPropagation()"
     (mouseup)="$event.stopPropagation()"
     (touchend)="$event.stopPropagation()">
    
    <!-- Top Relief Illusion (Shadow/Highlight) -->
    <svg class="absolute inset-0 w-full h-full pointer-events-none z-0" viewBox="0 0 320 520" preserveAspectRatio="none">
      <!-- Dark Shadow for depth -->
      <path d="M -20 115 Q 110 30, 320 18" 
            fill="none" 
            stroke="#450a0a" 
            stroke-width="4" 
            opacity="0.4" />
      <!-- Light highlight for the edge -->
      <path d="M -15 110 Q 110 25, 320 18" 
            fill="none" 
            stroke="#fca5a5" 
            stroke-width="1" 
            opacity="0.3" />
    </svg>

    <!-- Light Upper Indicator -->
    <div class="relative z-10 flex gap-4 mb-6 items-start -translate-y-2">
      <div class="w-12 h-12 bg-blue-400 rounded-full border-4 border-white shadow-[0_0_15px_rgba(96,165,250,0.8)] flex items-center justify-center relative overflow-hidden">
         <div class="absolute inset-0 bg-gradient-to-tr from-blue-600 to-transparent opacity-50"></div>
         <div class="w-4 h-4 bg-white/60 rounded-full -mt-4 -ml-4 z-10"></div>
      </div>
      <div class="flex gap-2 mt-2">
        <div class="w-3 h-3 bg-red-800 rounded-full border border-black shadow-inner animate-pulse"></div>
        <div class="w-3 h-3 bg-yellow-500 rounded-full border border-black shadow-inner"></div>
        <div class="w-3 h-3 bg-green-500 rounded-full border border-black shadow-inner"></div>
      </div>
    </div>

    <!-- Left Screen Display -->
    <div class="relative bg-slate-200 rounded-lg border-4 border-slate-300 shadow-inner flex flex-col flex-grow mb-2 mt-2">
      <div class="flex justify-center gap-4 py-1">
        <div class="w-2 h-2 bg-red-600 rounded-full"></div>
        <div class="w-2 h-2 bg-red-600 rounded-full"></div>
      </div>
      
      <div class="bg-black h-[260px] mx-2 mb-1 rounded border-4 border-slate-400 flex items-center justify-center overflow-hidden relative shadow-[inset_0_0_20px_rgba(0,0,0,1)]">
         @if (isOpen()) {
            <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 pointer-events-none bg-[length:100%_4px,3px_100%]"></div>
            
            @if (pokemon(); as pk) {
              @if (viewMode() === 'artwork') {
                <div class="absolute top-2 right-2 z-30">
                  <button 
                    (click)="displayMode.set(displayMode() === '2d' ? '3d' : '2d')"
                    class="bg-slate-800/80 hover:bg-slate-700 text-[10px] text-white w-10 h-6 flex items-center justify-center rounded border border-slate-600 font-black transition-colors shadow-lg active:scale-95"
                  >
                    {{ displayMode() === '2d' ? '3D' : '2D' }}
                  </button>
                </div>

                @if (displayMode() === '2d') {
                  <img 
                    [src]="pk.sprites.other?.['official-artwork']?.front_default || pk.sprites.front_default" 
                    [alt]="pk.name"
                    class="w-44 h-44 object-contain drop-shadow-[0_0_15px_rgba(255,255,255,0.4)] animate-fade-in"
                  >
                } @else {
                  <div class="w-full h-full animate-fade-in">
                    <app-pokemon-3d-viewer [modelUrl]="pk.model3d"></app-pokemon-3d-viewer>
                  </div>
                }
                <div class="absolute bottom-2 left-2 text-green-500 font-mono text-xs z-20">#{{pk.id}}</div>
              } @else {
                <div class="w-full h-full p-3 z-20 font-mono text-green-400 flex flex-col animate-fade-in">
                  <!-- Tab Header -->
                  <div class="flex justify-between gap-1 mb-3 border-b border-green-900/50 pb-2">
                    @for (tab of tabs; track tab; let i = $index) {
                      <button 
                        (click)="activeTab.set(i)"
                        class="text-[8px] flex-1 py-1 rounded border border-green-800 transition-all font-bold tracking-tight"
                        [class.bg-green-500]="activeTab() === i"
                        [class.text-black]="activeTab() === i"
                        [class.border-green-400]="activeTab() === i"
                      >
                        {{ tab }}
                      </button>
                    }
                  </div>

                  <div #scrollContainer class="flex-grow overflow-y-auto custom-scrollbar scroll-smooth pr-1">
                    
                    <!-- BIOS TAB -->
                    @if (activeTab() === 0) {
                      <div class="flex flex-col gap-3 animate-fade-in">
                        <div class="flex justify-between items-end border-b border-green-900 pb-1">
                          <span class="text-sm font-black uppercase tracking-tighter">{{ pk.name }}</span>
                          <span class="text-[10px] opacity-80">#{{ pk.id.toString().padStart(3, '0') }}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-[10px]">
                          <div class="flex flex-col">
                            <span class="opacity-50 text-[8px] font-bold">SPECIES</span>
                            <span class="truncate">{{ pk.species.name | uppercase }}</span>
                          </div>
                          <div class="flex flex-col">
                            <span class="opacity-50 text-[8px] font-bold">BASE EXP</span>
                            <span>{{ pk.base_experience }}</span>
                          </div>
                          <div class="flex flex-col">
                            <span class="opacity-50 text-[8px] font-bold">WEIGHT</span>
                            <span>{{ pk.weight / 10 }} kg</span>
                          </div>
                          <div class="flex flex-col">
                            <span class="opacity-50 text-[8px] font-bold">HEIGHT</span>
                            <span>{{ pk.height / 10 }} m</span>
                          </div>
                        </div>
                        
                        <div class="flex flex-col gap-1.5 mt-1">
                          <span class="opacity-50 text-[8px] font-bold border-l-2 border-green-500 pl-1">FORMS</span>
                          <div class="flex flex-wrap gap-1.5">
                            @for (f of pk.forms; track f.name) {
                              <span class="text-[9px] bg-green-900/30 px-2 py-0.5 border border-green-500/20 rounded-sm">{{ f.name | uppercase }}</span>
                            }
                          </div>
                        </div>

                        <div class="flex flex-col gap-1.5">
                          <span class="opacity-50 text-[8px] font-bold border-l-2 border-green-500 pl-1">ABILITIES</span>
                          <div class="flex flex-wrap gap-1.5">
                            @for (a of pk.abilities; track a.ability.name) {
                              <span class="text-[9px] border border-green-500/40 px-2 py-0.5 rounded-sm uppercase bg-green-950/50" [class.opacity-60]="a.is_hidden">
                                {{ a.ability.name.replace('-', ' ') }} @if (a.is_hidden) { [H] }
                              </span>
                            }
                          </div>
                        </div>
                      </div>
                    }

                    <!-- STATS TAB -->
                    @if (activeTab() === 1) {
                      <div class="flex flex-col gap-2.5 animate-fade-in pt-1">
                        @for (s of pk.stats; track s.stat.name) {
                          <div class="flex flex-col gap-1">
                            <div class="flex justify-between text-[9px] uppercase font-bold tracking-tight">
                              <span>{{ s.stat.name.replace('-', ' ') }}</span>
                              <span class="text-green-300">{{ s.base_stat }}</span>
                            </div>
                            <div class="w-full h-2 bg-green-950/50 rounded-full overflow-hidden border border-green-900">
                              <div class="h-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)] transition-all duration-500" [style.width.%]="(s.base_stat / 255) * 100"></div>
                            </div>
                          </div>
                        }
                      </div>
                    }

                    <!-- MOVES TAB -->
                    @if (activeTab() === 2) {
                      <div class="grid grid-cols-1 gap-1 animate-fade-in">
                        @for (m of pk.moves; track m.move.name) {
                          <div class="flex items-center gap-2 text-[10px] bg-green-900/10 border border-green-500/10 px-2 py-1.5 rounded uppercase group hover:bg-green-900/30 transition-colors">
                            <span class="text-[8px] opacity-40">●</span>
                            <span class="font-bold">{{ m.move.name.replace('-', ' ') }}</span>
                          </div>
                        }
                      </div>
                    }

                    <!-- DATA TAB -->
                    @if (activeTab() === 3) {
                      <div class="flex flex-col gap-4 animate-fade-in">
                        @if (pk.game_indices.length > 0) {
                          <div class="flex flex-col gap-2">
                            <span class="opacity-50 text-[8px] font-bold border-l-2 border-green-500 pl-1 uppercase">Game Version Indices</span>
                            <div class="grid grid-cols-2 gap-1.5">
                              @for (g of pk.game_indices; track g.version.name) {
                                <div class="text-[9px] border border-green-500/20 p-1.5 flex justify-between rounded-sm bg-green-950/20">
                                  <span class="uppercase font-bold text-green-300">{{ g.version.name }}</span>
                                  <span class="opacity-60">ID:{{ g.game_index }}</span>
                                </div>
                              }
                            </div>
                          </div>
                        }

                        @if (pk.held_items.length > 0) {
                          <div class="flex flex-col gap-2">
                            <span class="opacity-50 text-[8px] font-bold border-l-2 border-green-500 pl-1 uppercase">Natural Held Items</span>
                            <div class="flex flex-col gap-1">
                              @for (item of pk.held_items; track item.item.name) {
                                <div class="text-[10px] bg-green-500/10 border border-green-500/20 px-2 py-1 rounded-sm uppercase flex items-center gap-2">
                                  <span class="text-amber-500">★</span>
                                  {{ item.item.name.replace('-', ' ') }}
                                </div>
                              }
                            </div>
                          </div>
                        } @else {
                           <div class="text-[9px] opacity-40 text-center py-4 border border-dashed border-green-900 rounded">
                             NO HELD ITEMS DETECTED
                           </div>
                        }
                      </div>
                    }

                  </div>
                </div>
              }
            } @else {
              <div class="text-green-500 text-xs animate-pulse text-center p-4 font-mono">SYSTEM READY<br>AWAITING DATA...</div>
            }
         }
      </div>

      <div class="flex justify-between items-center px-4 pb-2">
        <button (click)="playCry()" 
                class="w-6 h-6 bg-red-600 rounded-full border-2 border-black flex items-center justify-center active:scale-90 transition-transform shadow-md group">
          <!-- Professional SVG Speaker Icon with two waves -->
          <svg viewBox="0 0 24 24" class="w-3.5 h-3.5 fill-white" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 5L6 9H2V15H6L11 19V5Z" />
            <path d="M15.54 8.46C16.4774 9.39764 17.004 10.6692 17.004 11.995C17.004 13.3208 16.4774 14.5924 15.54 15.53" stroke="white" stroke-width="1.5" stroke-linecap="round" fill="none"/>
            <path d="M19.07 4.93C20.9447 6.80528 21.9979 9.34836 21.9979 12.0001C21.9979 14.6519 20.9447 17.195 19.07 19.07" stroke="white" stroke-width="1.5" stroke-linecap="round" fill="none"/>
          </svg>
        </button>
        <div class="flex flex-col gap-1">
          <div class="w-8 h-1 bg-slate-800 rounded-full transition-transform" [class.vibrate-bar]="isPlaying()"></div>
          <div class="w-8 h-1 bg-slate-800 rounded-full transition-transform" [class.vibrate-bar]="isPlaying()"></div>
        </div>
      </div>
    </div>

    <!-- Physical Controls -->
    <div class="mt-auto flex justify-between items-center px-2 pb-4"
         (mousemove)="handleJoystickMove($event)"
         (touchmove)="handleJoystickMove($event)"
         (mouseup)="onJoystickEnd()"
         (touchend)="onJoystickEnd()"
         (mouseleave)="onJoystickEnd()">
      
      <!-- Analog Lever/Joystick -->
      <div id="joystick-base" 
           class="w-12 h-12 bg-slate-900 rounded-full border-4 border-slate-800 shadow-xl flex items-center justify-center relative shrink-0">
        <div 
          (mousedown)="onJoystickStart($event)"
          (touchstart)="onJoystickStart($event)"
          [style.transform]="'translate(' + joystickPos().x + 'px, ' + joystickPos().y + 'px)'"
          class="w-8 h-8 bg-gradient-to-br from-slate-700 to-slate-900 rounded-full border-2 border-black shadow-lg flex items-center justify-center transition-transform duration-75 cursor-grab active:cursor-grabbing select-none"
        >
          <div class="w-2 h-2 bg-slate-600 rounded-full blur-[0.5px]"></div>
        </div>
        <div class="absolute inset-0 rounded-full shadow-[inset_0_0_10px_rgba(0,0,0,0.8)] pointer-events-none"></div>
      </div>

      <!-- Mini Green Screen (Visualizer) - Centered -->
      <div (click)="playCry()" 
           class="w-24 h-12 bg-emerald-500/90 rounded border-2 border-slate-800 shadow-[inset_0_0_10px_rgba(0,0,0,0.5)] flex items-center justify-center relative overflow-hidden cursor-pointer active:scale-95 transition-transform -translate-y-1 mx-auto">
        <!-- Scanlines -->
        <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%)] z-10 pointer-events-none bg-[length:100%_2px]"></div>
        
        @if (isPlaying()) {
          <div class="flex items-end gap-1 h-6 z-20">
            @for (height of barHeights(); track $index) {
              <div class="w-1 bg-slate-900 rounded-full transition-all duration-75" [style.height.%]="height"></div>
            }
          </div>
        } @else {
          <div class="text-slate-900 font-mono text-[7px] font-bold animate-pulse tracking-tighter">OS READY</div>
        }
      </div>

      <!-- D-PAD -->
      <div class="d-pad-container relative w-16 h-16 shrink-0 flex items-center justify-center" 
           [class]="pressedDir()">
        <!-- The Continuous Cross Shape -->
        <div class="d-pad-cross"></div>
        
        <!-- Interactive Buttons (Invisible Layout on top) -->
        <div class="absolute inset-0 grid grid-cols-3 grid-rows-3">
          <div class="col-start-2 row-start-1 h-full w-full cursor-pointer" 
               (mousedown)="onDPadPress('up')" (mouseup)="onDPadRelease()" (mouseleave)="onDPadRelease()"
               (touchstart)="onDPadPress('up')" (touchend)="onDPadRelease()"></div>
          <div class="col-start-2 row-start-3 h-full w-full cursor-pointer" 
               (mousedown)="onDPadPress('down')" (mouseup)="onDPadRelease()" (mouseleave)="onDPadRelease()"
               (touchstart)="onDPadPress('down')" (touchend)="onDPadRelease()"></div>
          <div class="col-start-1 row-start-2 h-full w-full cursor-pointer" 
               (mousedown)="onDPadPress('left')" (mouseup)="onDPadRelease()" (mouseleave)="onDPadRelease()"
               (touchstart)="onDPadPress('left')" (touchend)="onDPadRelease()"></div>
          <div class="col-start-3 row-start-2 h-full w-full cursor-pointer" 
               (mousedown)="onDPadPress('right')" (mouseup)="onDPadRelease()" (mouseleave)="onDPadRelease()"
               (touchstart)="onDPadPress('right')" (touchend)="onDPadRelease()"></div>
          <!-- Center Dot -->
          <div class="col-start-2 row-start-2 flex items-center justify-center">
            <div class="w-2 h-2 bg-black/20 rounded-full"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
